<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üçã Limoncello ‚Äì Live Order Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QR Code Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background:
        linear-gradient(to bottom,
            rgba(255,255,255,0.1),
            rgba(255,255,255,0.5),
            rgba(255,255,255,0.85)
        ),
        url('https://i.postimg.cc/ryBVXgm8/Chat-GPT-Image-10-Ara-2025-10-55-35.png');
    background-size: cover;
    background-attachment: fixed;
    color: #5a4a2e;
}

.header {
    text-align: center;
    padding: 24px;
    font-size: 32px;
    background: #FFF4C7CC;
    backdrop-filter: blur(6px);
    font-weight: bold;
    color: #b67e2b;
    letter-spacing: 1px;
}

/* FORM */
form {
    max-width: 500px;
    margin: 20px auto;
    background: white;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 4px 14px #0003;
}
form input {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
}
form button {
    width: 100%;
    margin-top: 14px;
    padding: 12px;
    border: none;
    border-radius: 10px;
    background: #F4CD62;
    color: #7a5514;
    font-weight: bold;
    cursor: pointer;
}

/* BOARD */
.board {
    display: flex;
    gap: 18px;
    padding: 20px;
}
.column {
    flex: 1;
    background: rgba(255,255,255,0.75);
    padding: 14px;
    border-radius: 14px;
    min-height: 420px;
    box-shadow: 0 4px 10px #0002;
}
.column h2 {
    text-align: center;
    padding-bottom: 10px;
    margin-bottom: 18px;
    border-bottom: 2px solid #ffe9b0;
    color: #a46b21;
}

/* ORDER CARD */
.order {
    background: white;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 14px;
    box-shadow: 0 3px 10px #0002;
}
.name { font-size: 18px; font-weight: bold; color: #704b1f; }
.items { margin-top: 6px; }
.notes { margin-top: 6px; font-style: italic; opacity: 0.7; }

.timerBox {
    margin-top: 10px;
    font-size: 14px;
    background: #fff4d0;
    padding: 6px;
    border-radius: 8px;
}

/* BUTTONS */
.actionRow {
    margin-top: 12px;
    display: flex;
    gap: 8px;
}
.actionRow button {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    color: white;
}
.btn-prep { background: #FFB157; }
.btn-ready { background: #72C478; }
.btn-coll { background: #6F82FF; }

/* REVIEW PREVIEW */
.reviewPreview {
    background: #FFF2C1;
    margin-top: 10px;
    padding: 8px;
    border-radius: 10px;
    border-left: 4px solid #F4CD62;
    font-size: 14px;
}

/* QR MODAL */
#qrModal {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:#0005;
    display:none;
    align-items:center;
    justify-content:center;
}
#qrBox {
    background:white;
    padding:20px;
    border-radius:14px;
    border:6px solid #FFE48F;
    text-align:center;
}
.pastelFrame {
    padding:16px;
    background:#FFF9D7;
    border-radius:12px;
    display:inline-block;
}
</style>
</head>

<body>

<div class="header">üçã Limoncello ‚Äì Live Order Board</div>

<!-- FORM -->
<form id="orderForm">
    <input id="customerName" placeholder="Customer Name" required>
    <input id="itemSummary" placeholder="Item Summary" required>
    <input id="notes" placeholder="Notes (optional)">
    <button type="submit">Add Order</button>
</form>

<!-- BOARD -->
<div class="board">
    <div class="column">
        <h2>‚ú® New</h2>
        <div id="newContainer"></div>
    </div>
    <div class="column">
        <h2>üç≥ Preparing</h2>
        <div id="prepContainer"></div>
    </div>
    <div class="column">
        <h2>‚úîÔ∏è Ready</h2>
        <div id="readyContainer"></div>
    </div>
    <div class="column">
        <h2>üì¶ Collected</h2>
        <div id="collContainer"></div>
    </div>
</div>

<!-- QR MODAL -->
<div id="qrModal">
  <div id="qrBox">
    <h3>Customer Review QR</h3>
    <div class="pastelFrame"><div id="qrcode"></div></div>
    <br><br>
    <button onclick="closeQR()">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, updateDoc,
  onSnapshot, doc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* FIREBASE CONFIG ‚Äì CORRECTED */
const firebaseConfig = {
  apiKey: "AIzaSyAHR7lF9odKk31UrK_WK8DUZbqNSZKDmNo",
  authDomain: "order-app-4416e.firebaseapp.com",
  projectId: "order-app-4416e",
  storageBucket: "order-app-4416e.appspot.com",
  messagingSenderId: "262474090596",
  appId: "1:262474090596:web:2af310cccb61cc9b05b771"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* SOUND */
const ding = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
function playDing(){ ding.currentTime = 0; ding.play(); }

/* QR FUNCTION ‚Äî FIXED */
window.showQR = function(orderId) {
    qrModal.style.display = "flex";
    qrcode.innerHTML = "";

    const link = window.location.origin + "/restaurant/review.html?orderId=" + orderId;

    new QRCode(qrcode, {
        text: link,
        width: 200,
        height: 200
    });
};

window.closeQR = () => qrModal.style.display="none";

/* UPDATE STATUS */
window.updateStatus = async (id,newStatus)=>{
    await updateDoc(doc(db,"orders",id),{
        status:newStatus,
        statusTimestamp:Date.now()
    });
    playDing();
};

/* ADD ORDER */
orderForm.addEventListener("submit", async(e)=>{
    e.preventDefault();
    await addDoc(collection(db,"orders"),{
        customerName:customerName.value,
        itemSummary:itemSummary.value,
        notes:notes.value,
        status:"New",
        timestamp:Date.now(),
        statusTimestamp:Date.now()
    });
    playDing();
    orderForm.reset();
});

/* REALTIME LISTENER */
onSnapshot(collection(db,"orders"), snapshot=>{
    newContainer.innerHTML="";
    prepContainer.innerHTML="";
    readyContainer.innerHTML="";
    collContainer.innerHTML="";

    snapshot.forEach(docSnap=>{
        const o = docSnap.data();
        const id = docSnap.id;

        const createdMin = Math.floor((Date.now()-o.timestamp)/60000);
        const statusMin = Math.floor((Date.now()-(o.statusTimestamp||o.timestamp))/60000);

        let timerColor = "#fff4d0";
        if(statusMin>20) timerColor="#ffd2d2";
        else if(statusMin>10) timerColor="#ffe6b3";

        const card = document.createElement("div");
        card.className="order";

        card.innerHTML=`
            <div class='name'>${o.customerName}</div>
            <div class='items'>${o.itemSummary}</div>
            <div class='notes'>${o.notes||""}</div>

            <div class='timerBox' style='background:${timerColor}'>
                Created: ${createdMin} min ago<br>
                In status: ${statusMin} min
            </div>

            <div class='actionRow'>
                <button class='btn-prep'  onclick="updateStatus('${id}','Preparing')">Prep</button>
                <button class='btn-ready' onclick="updateStatus('${id}','Ready')">Ready</button>
                <button class='btn-coll'  onclick="updateStatus('${id}','Collected')">Collect</button>
            </div>

            ${
                o.status==="Collected"
                ? `<button style="margin-top:10px;width:100%" onclick="showQR('${id}')">‚≠ê Review QR</button>`
                : ""
            }

            ${
                o.review
                ? `<div class="reviewPreview">‚≠ê Rating: ${o.review.rating}<br><i>${o.review.comment}</i></div>`
                : ""
            }
        `;

        if(o.status==="New") newContainer.appendChild(card);
        if(o.status==="Preparing") prepContainer.appendChild(card);
        if(o.status==="Ready") readyContainer.appendChild(card);
        if(o.status==="Collected") collContainer.appendChild(card);
    });
});
</script>

</body>
</html>
